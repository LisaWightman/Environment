export LC_CTYPE=en_US.UTF-8
export TZ="US/Mountain"

export JAVA_OPTS="-Xms256m -Xmx512m"
export JAVA_HOME=/Library/Java/Home

SERVERPATH="/opt/local/bin /opt/local/lib/postgresql82/bin /Users/jvinding/projects/lm-scripts"

export WORKSPACE=/Users/jvinding/projects

. ~/Environment/git
. ~/Environment/git-completion.bash
. ~/Environment/tomcat


setcli() {
    export CLIENT=$1;
    echo "CLIENT=$CLIENT";
    goc
}
alias lm='setcli lm'
alias lmre='setcli lmre'
alias cl='setcli ds-core-lib'
alias cw='setcli ds-core-web'
alias lw='setcli lm-core-web'
alias ew='setcli ed-core-web'
alias ec='setcli ed-core'
alias cws='setcli ds-core-web-sandbox'
alias dex='setcli dex'
alias ssw='setcli self-serve-web'
alias tnz='setcli tnz'
alias edfi='setcli edfi'
alias tas='setcli ed-tas-ds'

#
#
#
alias ss='svn status'
alias ssu='svn status -u'
alias sup='[ -d .svn ] && svn up || gup'

clientmvn() {
    pushd $WORKSPACE/$CLIENT
    mvn $*
    popd
}
alias mvncp='clientmvn clean package && cpwar'
alias mvncpnt='clientmvn -Dmaven.test.skip=true clean package && cpwar'
alias mvnci='clientmvn clean install'
alias mvncint='clientmvn -Dmaven.test.skip=true clean install'

#
#
#
proj_list() {
    local lib=false
    local all=false
    local quick=false
    local edsa=false
    local pro=${CLIENT:=lm}
    while [ "$1" ]; do
        case $1 in
            -a ) all=true;;
            -e) edsa=true;;
            -l ) lib=true;;
            -q ) quick=true;;
            -* ) ;;
            * ) pro=$1;;
        esac
        shift
    done

    if [ "$quick" != "true" ]; then
        local projects="lm-core-web ds-core-web"

        if [ "$edsa" == "true" ]; then
            local projects="${projects} ed-core-web"
            if [ "$all" == "true" ] || [ "$lib" == "true" ]; then
                local projects="ed-core ${projects}"
            fi
        fi

        if [ "$all" == "true" ]; then
            projects="lm-util lm-mvc lm-taglib self-serve-lib reviews ds-core-lib ${projects}"
        elif [ "$lib" == "true" ]; then
            projects="ds-core-lib ${projects}"
        fi
    fi
    if ! [ -z "$projects" ]; then
        echo -n "$projects "
    fi
    echo -n $pro
}
switch_deps() {
    local deps=$(proj_list "$@")
    local proj=${deps##* }
    deps=${deps% *}

    for p in $deps; do
        setcli $p > /dev/null
        local branch=$(git b | grep $proj)
        if ! [ -z "$branch" ]; then
            if [ "$branch" == "* $proj" ]; then
                echo "$p is already on $proj"
            elif git co $proj > /dev/null; then
                echo "$p switched to $proj"
            else
                echo -e "\033[1;31m$p could not switch to $proj\033[0;0m"
                return 1
            fi
        else
            echo -e "\033[1;31m$p does not have a branch called $proj\033[0;0m"
            return 1
        fi
    done
}
#
#
#
build() {
    local deps=$(proj_list "$@")
    local proj=${deps##* }
    deps=${deps% *}

    local switchdeps=false
    local mvnargs=-DskipTests=true

    while getopts ":td" opt
    do
        case $opt in
            d ) switchdeps=true;;
            t ) mvnargs=;;
        esac
    done

    if [ "$switchdeps" == "true" ]; then
        switch_deps "$@" || return 1
    fi

    for p in $deps; do
        setcli $p && sup && mvn $mvnargs clean install || { echo; echo -e "\033[1;31mfailed in $p\033[0;0m"; setcli $proj; return 1; }
    done

    setcli $proj && sup && mvn $mvnargs clean package && cpwar || { echo; echo -e "\033[1;31mfailed in $proj\033[0;0m"; setcli $proj; return 1; }

    echo -e "\033[1;32mBuilt $proj successfully\033[0;0m"
}

#
# maven/svn dirs
#
cpwar() { cp $WORKSPACE/$CLIENT/target/*.war $CATALINA_HOME/webapps; }
goc() {
    if [ -d $WORKSPACE/$CLIENT/$1 ]; then
        cd $WORKSPACE/$CLIENT/$1
    else
        cd $WORKSPACE
    fi
}
gow() { goc src/main/webapp/$1; }
alias gowjsp='gow WEB-INF/jsp'
alias gojs='gow js'
alias gocss='gow css'
alias gojsp='gow WEB-INF/jsp'

## twx() { touch $CATALINA_HOME/webapps/${CLIENT}DS/WEB-INF/web.xml; }

alias lc='while ! ldt; do sleep 1; done;'

alias lat='tail -100f `ls -1 $CATALINA_HOME/logs/localhost_access* | tail -1`'

alias homev='vncviewer -geometry=1024x768 -FullColor -PreferredEncoding=ZRLE -ZlibLevel=9 -via 24.8.98.73 localhost:0'

alias ie5='/usr/bin/vncviewer --ZlibLevel=9 --Shared 10.4.0.59:0'
alias mac='/usr/bin/vncviewer --ZlibLevel=9 --Shared 10.4.1.169'

alias rsreload='java -jar ~/bin/jmx.jar - localhost:1099 DestinationSearch:Context=${CLIENT}ds,name=ResourceSet reloadConfiguration'
alias rsnofilter='java -jar ~/bin/jmx.jar - localhost:1099 DestinationSearch:Context=${CLIENT}ds,Class=ConcatenatingFilterSet,name=javascriptFilterSet setFilteringEnabledString=false'

svn_checkout() {
    dir=$2
    if [ -z "$file" ]; then
        dir=${1%%/trunk}
        dir=${dir##*/}
    fi
    svn co https://build.corp.localmatters.com/subversion/DestinationSearch/$1 $dir
}

# sudo launchctl load /Library/LaunchDaemons/org.postgresql.dbms.plist

alias mysql=mysql5